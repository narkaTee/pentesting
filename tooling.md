# General

- https://github.com/penetration-testing-execution-standard/ptes

## Metasploit

- armitage gui for easier network discovery
- msfcli for scripting?
- msfconsole interactive

## (PowerShell) Empire

- [(powershell) empire](https://github.com/BC-SECURITY/Empire)
- https://www.kali.org/tools/powershell-empire/
- [starkiller](https://github.com/BC-SECURITY/Starkiller)
- https://www.kali.org/tools/starkiller/

### Modules

- exploit
- payload
- encoder: hiding from scanners
- nops: payload stability: try to prevent crashed when running payloads
- auxiliary: info gathering


# Information Gathering

## passive

### CLI

- whatweb
- [httrack](https://www.httrack.com/)
- [wafw00f](https://github.com/EnableSecurity/wafw00f)
- [sublist3r](https://github.com/aboul3la/Sublist3r)
- [theharvester](https://github.com/laramies/theHarvester)

### Firefox

- BuiltWith
- Wappaliyzer

### Web

- https://sitereport.netcraft.com/
- https://www.exploit-db.com/google-hacking-database
- https://dnsdumpster.com/
- https://www.domaincodex.com/
- https://netlas.io/
- https://fullhunt.io/
- https://binaryedge.io/
- https://haveibeenpwned.com/

## active

### CLI

- dig
  - `dig axfr <you know the rest>`
- dnsenum
- fierce
- nmap
- netdiscover
- smbmap
- rpcclient
- nmblookup
- msfconsole
- enum4linux
- hydra (bruteforce)
- dirb
- browsh
- nessus

#### Protocol enum

##### SMB

Usefull commands
- rpcclient
    - lookupnames: SID Lookup
- metasploit `search type:auxiliary smb`
    - auxiliary/scan/smb/smb_enumshares
    - auxiliary/scan/smb/smb
    - auxiliary/scan/smb/smb2
    - auxiliary/scan/smb/smb_login
    - auxiliary/scan/smb/pipe_auditor

##### FTP
- metasploit `search type:auxiliary ftp`
    - auxiliary/scanner/ftp/ftp_login

##### SSH

- nmap
    - ssh2-enum-algos
    - ssh2-hostkey --script-args ssh_hostkey=full
    - ssh-auth-methods --script-args="ssh.user=<user>"
- metasploit `search type:auxiliary ssh`
    - auxiliary/scanner/ssh/ssh_version
    - auxiliary/scanner/ssh/ssh_enumusers
    - auxiliary/scanner/ssh/ssh_login

##### HTTP

- nmap scripts
    - http-enum
    - http-headers
    - http-methods args http-methods.url-path=
    - http-webdav-scan
    - http-shellshock --script-args "https-shellshock.uri=<uri>"
- metasploit `search type:auxiliary http`
    - auxiliary/scanner/http/brute_dirs
    - auxiliary/scanner/http/dir_scanner (dict attack)
    - auxiliary/scanner/http/http_header
    - auxiliary/scanner/http/robots_txt
    - auxiliary/scanner/http/http_login
    - auxiliary/scanner/http/http_put
    - auxiliary/scanner/http/apache_userdir_enum

##### mysql

- nmap
    - mysql-empty-password
    - mysql-info
    - mysql-users args mysqluser=<user>,mysqlpassword=<pass>
    - mysql-databases args ^^
    - mysql-audit args mysqlaudit.username= mysql-audit.password= mysql-audit.filename=/usr/share/nmap/nselib/data/mysql-cis.audit
    - mysql-dump-hashes args username= password=
- metasploit `search type:auxiliary mysql`
    - auxiliary/scanner/mysql/mysql_writeable_dirs
    - auxiliary/scanner/mysql/mysql_hashdump
    - auxiliary/scanner/mysql/mysql_login
    - auxiliary/scanner/mysql/mysql_version
    - auxiliary/scanner/mysql/mysql_enum
    - auxiliary/admin/mysql/mysql_sql
    - auxiliary/scanner/mysql/mysql_schemadump
- mssql query
    - load_file

##### MSSQL

- nmap
    - ms-sql-info
    - ms-sql-ntml-info args mssql.instance-port
    - ms-sql-nrute args userdb= passdb=
    - ms-sql-empty-password
    - ms-sql-query args mssql.username= mssql.password=,ms-sql-query.query=
    - ms-sql-dump-hashes args mssql.uername=,mssql.password=
    - ms-sql-xp-cmdshell args mssql.uername=,mssql.password=,ms-sql-xp-cmdshell.cmd=
- query
    - select * from master..syslogins
- metasploit `search type:auxiliary mssql`
    - auxiliary/scanner/mssql/mssql_login
    - auxiliary/admin/mssql/mssql_enum
    - auxiliary/admin/mssql/mssql_enum_sql_logins
    - auxiliary/admin/mssql/mssql_exec
    - auxiliary/admin/mssql/mssql_enum_domain_accounts

##### SMTP

- metasploit `search type:auxiliary smtp`
    - auxiliary/scanner/smtp/smtp_version
    - auxiliary/scanner/smtp/smtp_enum
    - auxiliary/scanner/smtp/smtp_relay

### sniffing
- wireshark
- arp-scan
- ping
- fping
- zenmap
- nmap automator
- rustscan
- autorecon


### CVE

- nessus
- searchsploit
- [exploit-db.com](https://exploit-db.com)
- [rapid7 db](https://www.rapid7.com/db/) will probably have metasploit modules
- WMAP
- metasploit
    - `search` command
    - `search type:exploit <whatever>`
    - https://github.com/hahwul/metasploit-autopwn
        - `load db_autopwn`
        - `db_autopwn -h`
        - `db_autopwn -p -t`: matching exploits for ALL open ports
        - `db_autopwn -p -t -PI <port range>`
    - Nessus Import
        - `db_import <path to .nessus file> `
    - wmap `wmap_*`
        - `wmap_sites`
        - `wmap_run`

#### Nessus

Useful filters:
- severity
- metasploit

### Auditing Tools

- SCAP Compliance Scanner
- Stigviewer

# Exploit

## msfvenom/metasploit cheat sheet

- msfvenom --list payloads
- msfconsole
    - use multi/handler setup payload listener
        - set same payload!

## webdav
- davtest
- cadaver
- metasploit
    - exploit/windows/iis/iis_webdav_upad_asp
- msfvenom

## smb
- psexec
- metasploit
    - exploit/windows/smb/psexec

## tomcat
- metasploit
    - `search type:exploit tomcat`

## RDP
- metasploit
    - auxiliary/scanner/rdp/rdp_scanner
- hydra
- xfreerdp /u:user /p:pw /v:host:port

## WinRM

port 5985

- crackmapexec
- evil-winrm
- metasploit
    - auxiliary/scanner/winrm/winrm_login
    - scanner/winrm/winrm_cmd

## Windows Kernel

- windows exploit suggester
- metasploit
    - multi/recon/local_exploit_suggester

## Linux Kernel

- linux-exploit-suggester

## UAC

bypass uac prompt with access to an local administator

- UACMe
- metasploit `search type:exploit uac`
    - exploit/windows/local/bypassuac_injection

## Window Access Token

- meterpreter (Incognito module):`load incognito`
    - Gather`list_tokens -u`
    - use: `impersonate_token <username>`

- managed by LSASS (Local Security Authority Subsystem Service)
- generated by winlogin.exe during login and passed to userinit.exe

- impersonate token (non interactive login)
    - local only
- delegate level token (interactive login, RDP)
    - can be used on other systems

Important priveleges to facilitate:

- SeAssignPrimaryToken
- SeCreateToken
- SeImpersonatePrivilege

## ADS (Alternative Data Stream)

common evasion tatic to hide from users/administrators.

Pattern: `<visable-file>:<hidden filename>`

save a file `file:hidden` only file will the visible.

## Credentials Dumping

### Windows unattended installation paths

Files might be present here or in subdirectories:

- c:\Windows\Panther\Unattend.xml
- c:\Windows\Panther\Autounattend.xml

Secrets might be base64 encoded.

### SAM DB Hasdump

- mimikatz
- meterpreter session: kiwi extension `load kiwi` (just build in mimikatz)

### Linux Hashes

Hash prefixes see [`crypt` man page](https://manpages.debian.org/testing/libcrypt-dev/crypt.5.en.html)

Common:

* `$1` MD5
* `$2` Blowfish
* `$5` SHA-256
* `$6` SHA-512
* `$y` yescrypt

Metasploit Hash and Credentials dump modules:
- `post/linux/gather/hashdump`
- `post/multi/gather/ssh_creds`
- `post/multi/gather/docker_creds`
- `post/linux/gather/ecryptfs_creds`
- `post/linux/gather/enum_psk`
- `post/linux/gather/enum_xchat`
- `post/linux/gather/phpmyadmin_credsteal`
- `post/linux/gather/pptpd_chap_secrets`
- `post/linux/manage/sshkey_persistence`

# Privilege Escalation

- winPEAs

## Windows: pass-the-hash

- metaploit psexec module
    - exploit/windows/smb/psexec
      Requires LN and NTLM hashes: SMBPass <LN>:<NTLM>
      Try different target options if it does not work
- crackmapexec
- evil-winrm

## Linux SUID

- https://gtfobins.github.io/
- metersploit (very little kernel exploit tooling) `search platform:linux type:exploit <whatever>`
    - chkrootkit

# Network

## arp

you might want to enable routing first `/proc/sys/net/ipv4/ip_forward`

- arpspoof -i <if> -t <target> [-r, use this to poison booth hosts to get bidrirectional MITM access] <host to redirect>

# Post Exploitation

## Windows Post Exploitation

### Windows Enumeration

- metasploit `search type:post platform:windows <whatever>`
    - `post/windows/gather/win_privs`
    - `post/windows/gather/enum_logged_on_users`
    - `post/windows/gather/enum_applications`
    - `post/windows/gather/checkvm`
    - `post/windows/gather/enum_av_excluded`
    - `post/windows/gather/enum_computers`
    - `post/windows/gather/enum_patches`
        - if it does not work try manual: `systeminfo` command on windows
    - `post/windows/gather/enum_shares`
    - `post/windows/manager/enable_rdp`

### Persistence

- metersploit
    - `search platform:<platform> persistence`
    - `exploit/windows/local/persistence_service`
        - remember to set payload
    - regain access with `multi/handler`

### Enable RDP

- metersploit
    - `search enable_rdp`

### keylogging

- metersploit (via meterpreter, might need x64 session)
    - `keyscan_start`
    - `keyscan_end`
    - `keyscan_dump`

### Clearing Windows Eventlogs

- metersploit (meterpreter)
    - `clearev`

## Linux Post Exploitation

### Linux Enumeration

- metasploit `search type:post platform:liux <whatever>`
    - `post/linux/gather/enum_configs`
    - `post/multi/gather/env`
    - `post/linux/gather/enum_network`
    - `post/linux/gather/enum_protections`
    - `post/linux/gather/enum_system`
    - `post/linux/gather/checkcontainer`
    - `post/linux/gather/checkvm`
    - `post/linux/gather/enum_users_history`
    - `post/multi/manage/system_session`
    - `post/linux/manage/download_exec`

### Persistence

- create backdoor user `adduser -m <user> -s  <shell> && usermod -aG root <user>`
    - change user id `usermod -u <id> <user>`
- metersploit `search platform:linux persistence`
